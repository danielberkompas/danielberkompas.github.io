<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Cloak Your Ecto Data</title>
  <meta property="og:title" content="Cloak Your Ecto Data" />
  <meta name="twitter:title" content="Cloak Your Ecto Data" />
  <meta name="description" content="I&rsquo;ve written previously about how to encrypt your data when you are using Ecto, here:

Encrypting Data With Ecto
Changing Your Ecto Encryption Key

After deciding to use encryption for one of my personal projects, I decided that the techniques I wrote about
should be built into a Hex package. With that in mind&hellip;">
  <meta property="og:description" content="I&rsquo;ve written previously about how to encrypt your data when you are using Ecto, here:

Encrypting Data With Ecto
Changing Your Ecto Encryption Key

After deciding to use encryption for one of my personal projects, I decided that the techniques I wrote about
should be built into a Hex package. With that in mind&hellip;">
  <meta name="twitter:description" content="I&rsquo;ve written previously about how to encrypt your data when you are using Ecto, here:

Encrypting Data With Ecto
Changing Your Ecto Encryption Key

After deciding to use encryption for one of my â€¦">
  <meta name="author" content="Daniel Berkompas"/>
  <link href='https://blog.danielberkompas.com/img/favicon-96x96.png' rel='icon' type='image/x-icon'/>
  <meta property="og:image" content="https://blog.danielberkompas.com/img/avatar-blue.jpg" />
  <meta name="twitter:image" content="https://blog.danielberkompas.com/img/avatar-blue.jpg" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@dberkom" />
  <meta name="twitter:creator" content="@dberkom" />
  <meta property="og:url" content="https://blog.danielberkompas.com/2015/09/22/cloak-your-ecto-data/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Random Bits" />

  <meta name="generator" content="Hugo 0.36.1" />
  <link rel="canonical" href="https://blog.danielberkompas.com/2015/09/22/cloak-your-ecto-data/" />
  <link rel="alternate" href="https://blog.danielberkompas.com/index.xml" type="application/rss+xml" title="Random Bits">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://blog.danielberkompas.com/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://blog.danielberkompas.com/css/syntax.css" /><link rel="stylesheet" href="https://blog.danielberkompas.com/css/codeblock.css" /><link rel="stylesheet" href="https://blog.danielberkompas.com/css/project.css" />
<link rel="stylesheet" href="https://blog.danielberkompas.com/css/overrides.css" />


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">



<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-23392891-3', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>

</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://blog.danielberkompas.com/">Random Bits</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="Projects" href="/projects">Projects</a>
            </li>
          
        
          
            <li>
              <a title="About" href="/about">About</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        

        

        
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
          <a title="Random Bits" href="https://blog.danielberkompas.com/">
            <img class="avatar-img" src="https://blog.danielberkompas.com/img/avatar-blue.jpg" alt="Random Bits" />
          </a>
        
      </div>
    </div>

  </div>
</nav>




    
  
  
  




  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              <h1>Cloak Your Ecto Data</h1>
                
                
                  <span class="post-meta">
  
  
  <i class="fa fa-calendar-o"></i>&nbsp;Posted on September 22, 2015
  
  
  &nbsp;|&nbsp;
  <i class="fa fa-clock-o"></i> 4 minutes (744 words)
  
  
</span>


                
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>I&rsquo;ve written previously about how to encrypt your data when you are using <a href="https://github.com/elixir-lang/ecto">Ecto</a>, here:</p>

<p><a href="http://blog.danielberkompas.com/elixir/security/2015/07/03/encrypting-data-with-ecto.html">Encrypting Data With Ecto</a><br />
<a href="http://blog.danielberkompas.com/elixir/security/2015/07/09/changing-your-ecto-encryption-key.html">Changing Your Ecto Encryption Key</a></p>

<p>After deciding to use encryption for one of my personal projects, I decided that the techniques I wrote about
should be built into a <a href="http://hex.pm">Hex</a> package. With that in mind&hellip;</p>

<h2 id="presenting-cloak">Presenting Cloak</h2>

<p>I&rsquo;m pleased to present <a href="https://github.com/danielberkompas/cloak">Cloak</a>, a simple encryption package designed to be used with Ecto. It implements all the ideas I&rsquo;ve written about, and then some. It supports:</p>

<ul>
<li>Seamless encryption/decryption of model fields</li>
<li>Zero-downtime migrations to new keys <em>and cipher suites</em></li>
<li>Multiple ciphers in use at once (though only one will be used for encryption)</li>
</ul>

<h3 id="configuration">Configuration</h3>

<p>It&rsquo;s simple to use. Select a cipher (there&rsquo;s only one currently, AES CTR), and then configure it in your <code>config/config.exs</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-elixir" data-lang="elixir"><span class="n">config</span> <span class="ss">:cloak</span><span class="p">,</span> <span class="p"></span><span class="nc">Cloak.AES.CTR</span><span class="p">,</span>
  <span class="ss">tag</span><span class="p">:</span> <span class="s2">&#34;AES&#34;</span><span class="p">,</span>
  <span class="ss">default</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
  <span class="ss">keys</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">%{</span><span class="ss">tag</span><span class="p">:</span> <span class="p">&lt;&lt;</span><span class="mi">1</span><span class="p">&gt;&gt;,</span> <span class="ss">key</span><span class="p">:</span> <span class="ss">:base64</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;your key here&#34;</span><span class="p">),</span> <span class="ss">default</span><span class="p">:</span> <span class="n">true</span><span class="p">}</span>
  <span class="p">]</span></code></pre></div>
<p>The <code>:tag</code> for the given cipher module will be prepended to any ciphertext generated by that module. <code>:default</code> controls whether this cipher should be the default for encrypting new values, and the <code>:keys</code> array holds a list of keys to use.</p>

<p>Each key also has a <code>:tag</code>, which will become part of each ciphertext, and a <code>:default</code> setting to control whether it should be used for new encryption.</p>

<p>You can then use the <code>Cloak.encrypt/1</code> and <code>Cloak.decrypt/1</code> functions directly to encrypt and decrypt values using the default cipher module:</p>
<div class="highlight"><pre class="chroma"><code class="language-elixir" data-lang="elixir"><span class="c1"># Delegates encryption work to Cloak.AES.CTR.encrypt/1</span>
<span class="p"></span><span class="nc">Cloak</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="s2">&#34;Hello, World!&#34;</span><span class="p">)</span>
<span class="c1"># =&gt; &lt;&lt;65, 69, 83, 1, 235, 128, 59, ...&gt;&gt;</span>

<span class="p"></span><span class="nc">Cloak</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="s2">&#34;Hello, World!&#34;</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="p"></span><span class="nc">Cloak</span><span class="o">.</span><span class="n">decrypt</span>
<span class="c1"># =&gt; &#34;Hello, World!&#34;</span></code></pre></div>
<p><code>Cloak</code> is able to distinguish between ciphertext based on the <code>:tag</code>s. For example, when using the <code>Cloak.AES.CTR</code> cipher module, <code>Cloak</code> will generate ciphertext in this format:</p>

<table>
<thead>
<tr>
<th>Cipher Tag <br /><small>(n bytes)</small></th>
<th>Key Tag <br /><small>(1 byte)</small></th>
<th>IV <br /><small>(16 bytes)</small></th>
<th>Ciphertext <br /><small>(n bytes)</small></th>
</tr>
</thead>

<tbody>
<tr>
<td>&ldquo;AES&rdquo;</td>
<td>1</td>
<td>&lt;<235, 128, 59, 167, 97, ...>&gt;</td>
<td>&lt;<89, 228, 1, 111, 197, 201, ...>&gt;</td>
</tr>
</tbody>
</table>

<p>When you call <code>Cloak.decrypt/1</code>, <code>Cloak</code> will use the cipher tag to determine which module created the ciphertext, and will then pass <em>the rest</em> of the binary to that module&rsquo;s <code>decrypt/1</code> function for decryption.</p>

<p>This allows <code>Cloak</code> to continue to decrypt old values seamlessly, even if you&rsquo;ve set up a new <code>:default</code> encryption module or key.</p>

<h2 id="ecto-integration">Ecto Integration</h2>

<p>It&rsquo;s easy to integrate <code>Cloak</code> with Ecto. Add the field you intend to encrypt to your database; it should be a <code>:binary</code> field.</p>
<div class="highlight"><pre class="chroma"><code class="language-elixir" data-lang="elixir"><span class="n">defmodule</span> <span class="p"></span><span class="nc">User</span> <span class="n">do</span>
  <span class="n">use</span> <span class="p"></span><span class="nc">Ecto.Model</span>

  <span class="n">schema</span> <span class="s2">&#34;users&#34;</span> <span class="n">do</span>
    <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:binary</span>
  <span class="n">end</span>
<span class="n">end</span></code></pre></div>
<p>Then, replace the <code>:binary</code> type with <code>Cloak.EncryptedBinaryField</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-elixir" data-lang="elixir"><span class="n">defmodule</span> <span class="p"></span><span class="nc">User</span> <span class="n">do</span>
  <span class="n">use</span> <span class="p"></span><span class="nc">Ecto.Model</span>

  <span class="n">schema</span> <span class="s2">&#34;users&#34;</span> <span class="n">do</span>
    <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="p"></span><span class="nc">Cloak.EncryptedBinaryField</span>
  <span class="n">end</span>
<span class="n">end</span></code></pre></div>
<p>And that&rsquo;s it! The <code>:name</code> field will be transparently encrypted and decrypted with the cipher module you configured.</p>

<p>Cloak supports string fields, map fields, integer fields, float fields, and SHA256 hash fields as of this writing. I&rsquo;m definitely open to contributions!</p>

<h2 id="migrating-to-a-new-key-or-cipher">Migrating to a New Key or Cipher</h2>

<p>Because Cloak tags every piece of ciphertext with metadata, you don&rsquo;t <em>have</em> to do anything when you switch to a new key. Old data will be gradually converted to the new key or cipher as your app is used.</p>

<p>At the very least, this means that your app can stay up during the transition. However, you usually will want to proactively migrate rows to the new key. To do so, you will need to track which encryption configuration was used to encrypt each row, so that you can know which rows need to be migrated.</p>

<p>Add an <code>:encryption_version</code> field to your module, with a <code>:binary</code> type, and <code>use</code> the <code>Cloak.Model</code> module.</p>
<div class="highlight"><pre class="chroma"><code class="language-diff" data-lang="diff">defmodule User do
  use Ecto.Model
<span class="gi">+ use Cloak.Model, :encryption_version
</span><span class="gi"></span>
  schema &#34;users&#34; do
    field :name, Cloak.EncryptedBinaryField
<span class="gi">+   field :encryption_version, :binary
</span><span class="gi"></span>  end
end
</code></pre></div>
<p>This will set up <code>before_insert</code> and <code>before_update</code> hooks on your model to save metadata about the encryption that was used to encrypt that module in the <code>:encryption_version</code> field.</p>

<p>Next, configure your <code>:migration</code> settings in <code>config/config.exs</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-elixir" data-lang="elixir"><span class="n">config</span> <span class="ss">:cloak</span><span class="p">,</span> <span class="ss">:migration</span><span class="p">,</span>
  <span class="ss">repo</span><span class="p">:</span> <span class="p"></span><span class="nc">Repo</span><span class="p">,</span>
  <span class="ss">models</span><span class="p">:</span> <span class="p">[</span><span class="nc">User</span><span class="p">]</span> <span class="c1"># A list of modules that you want to migrate</span></code></pre></div>
<p>Then, simply run the following mix task, and all the rows in your database will be proactively migrated to the new <code>:default</code> encryption configuration!</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ mix cloak.migrate</code></pre></div>
<h2 id="conclusion">Conclusion</h2>

<p>I hope this package will be useful to others out there. If you have any
suggestions or ideas, please let me know over <a href="https://github.com/danielberkompas/cloak">on Github</a>.</p>

<hr />

<h4 id="more-documentation">More Documentation?</h4>

<p>See the <a href="http://hexdocs.pm/cloak">Hex documentation for Cloak</a> for more in-depth information.</p>

<h4 id="contributing">Contributing</h4>

<p>I realize that only supporting AES CTR encryption is somewhat limiting. If you&rsquo;d like to contribute more encryptors, I&rsquo;m accepting PRs at
<a href="https://github.com/danielberkompas/cloak">Cloak&rsquo;s Github repo</a>.</p>
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://blog.danielberkompas.com/2015/09/03/better-pipelines-with-monadex/" data-toggle="tooltip" data-placement="top" title="Better Pipelines with Monadex">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://blog.danielberkompas.com/2015/09/25/announcing-learn-elixir-tv/" data-toggle="tooltip" data-placement="top" title="Announcing LearnElixir.tv">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      
        
          <div class="disqus-comments">
            <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "dberkomcodeblog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
        
        
      

    </div>
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="https://github.com/danielberkompas" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/dberkom" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://linkedin.com/in/danielberkompas" title="LinkedIn">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            
            <a href="https://blog.danielberkompas.com/index.xml" title="RSS">
            
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="danielberkompas.com">Daniel Berkompas</a>
            
          

          &nbsp;&bull;&nbsp;
          2018

          
            &nbsp;&bull;&nbsp;
            <a href="https://blog.danielberkompas.com/">Random Bits</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.36.1</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://blog.danielberkompas.com/js/main.js"></script><script> renderMathInElement(document.body); </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script>
<script src="https://blog.danielberkompas.com/js/load-photoswipe.js"></script>






  </body>
</html>

